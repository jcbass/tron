<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tron Control</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.classless.min.css"
    >
    <style>
      :root {{
        color-scheme: light dark;
      }}

      body {{
        margin: 0;
      }}

      main.container {{
        max-width: 720px;
        margin: 0 auto;
        padding: 2rem 1rem 4rem;
      }}

      article.control-panel {{
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }}

      .panel-header {{
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
        gap: 1rem;
      }}

      .panel-header h1 {{
        margin: 0;
      }}

      .panel-toggle {{
        display: inline-flex;
        align-items: center;
        justify-content: flex-start;
        gap: 0.75rem;
        font-weight: 600;
      }}

      .panel-toggle input[type="checkbox"] {{
        transform: scale(1.2);
      }}

      .panel-toggle span {{
        white-space: nowrap;
      }}

      .control-section {{
        display: flex;
        flex-direction: column;
      }}

      .control-section > * + * {{
        margin-top: 1.5rem;
      }}

      .control-section > h2 {{
        margin: 0;
      }}

      .control-section > h2 + * {{
        margin-top: 0;
      }}

      .control-section + .control-section {{
        margin-top: 2rem;
      }}

      .control-group {{
        display: grid;
        gap: 1rem;
      }}

      .toggle-field {{
        display: flex;
        justify-content: flex-start;
        align-items: center;
      }}

      .power-toggle {{
        font-size: 1rem;
      }}

      .slider-field {{
        display: grid;
        gap: 0.5rem;
      }}

      .slider-field label {{
        display: flex;
        justify-content: space-between;
        align-items: baseline;
      }}

      .slider-field output {{
        font-size: 0.875rem;
        font-variant-numeric: tabular-nums;
      }}

      .slider-field input[type="range"] {{
        width: 100%;
      }}

      .animation-section {{
        display: grid;
        gap: 1.5rem;
      }}

      .animation-sliders {{
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }}

      .switch-field {{
        display: inline-flex;
        align-items: center;
        justify-content: flex-start;
        gap: 0.75rem;
        font-weight: 600;
      }}

      .switch-field input[type="checkbox"] {{
        transform: scale(1.1);
      }}

      .range-table {{
        display: grid;
        gap: 1rem;
      }}

      .range-row {{
        display: grid;
        gap: 0.25rem;
      }}

      .range-row .range-label {{
        font-weight: 600;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }}

      .range-inputs {{
        display: grid;
        gap: 0.5rem;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }}

      .range-inputs input[type="number"] {{
        width: 100%;
        padding: 0.3rem 0.5rem;
        line-height: 1.2;
        min-height: 0;
        font-variant-numeric: tabular-nums;
      }}

      @media (max-width: 600px) {{
        .animation-sliders {{
          grid-template-columns: 1fr;
        }}

        .range-inputs {{
          gap: 0.5rem;
        }}
      }}

      .actions-bar {{
        margin-top: 2rem;
        padding-top: 1rem;
      }}

      .actions {{
        display: flex;
        justify-content: flex-end;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }}

      #status {{
        min-height: 1.5rem;
      }}
    </style>
  </head>
  <body>
    <main class="container">
      <article class="control-panel">
        <form id="settings-form" action="/set" method="post" onsubmit="saveSettings(event)">
          {hidden_fields}
          <header class="panel-header">
            <h1>Tron</h1>
          </header>
          <section class="control-section">
            <div class="control-group">
              <div class="field toggle-field">
                <label class="panel-toggle power-toggle">
                  <span>Power</span>
                  <input type="checkbox" id="strip_on" name="strip_on"{strip_on_checked} role="switch" aria-label="Tron power">
                  <span id="power-state" data-on="On" data-off="Off">{power_state}</span>
                </label>
              </div>
              <div class="field slider-field">
                <label for="strip_brightness">
                  <span>Brightness</span>
                  <output id="strip_brightness_output">{brightness_percent}%</output>
                </label>
                <input type="range" id="strip_brightness" name="strip_brightness" min="0" max="1" 
                       step="0.01" value="{brightness_value:.2f}" data-output="strip_brightness_output" 
                       data-format="percent">
              </div>
              <div class="field slider-field">
                <label for="strip_colortemp">
                  <span>Color Temperature</span>
                  <output id="strip_colortemp_output">{colortemp_value} K</output>
                </label>
                <input type="range" id="strip_colortemp" name="strip_colortemp" min="{colortemp_min}" 
                       max="{colortemp_max}" step="1" value="{colortemp_value}" 
                       data-output="strip_colortemp_output" data-format="integer" data-suffix=" K">
              </div>
            </div>
          </section>
          <section class="control-section">
            <h2>Animation Parameters</h2>
            <div class="animation-section">
              <div class="animation-sliders">
                <div class="field slider-field">
                  <label for="param_brightness_factor">
                    <span>Brightness</span>
                    <output id="param_brightness_factor_output">{param_brightness_factor_output}</output>
                  </label>
                  <input type="range" id="param_brightness_factor" name="BRIGHTNESS_FACTOR" min="0" max="1"
                         step="0.01" value="{param_brightness_factor_value}" data-output="param_brightness_factor_output"
                         data-format="percent">
                </div>
                <div class="field slider-field">
                  <label for="param_temperature">
                    <span>Temperature</span>
                    <output id="param_temperature_output">{param_temperature_output}</output>
                  </label>
                  <input type="range" id="param_temperature" min="0" max="100" step="1"
                         value="{param_temperature_value}" data-output="param_temperature_output"
                         data-format="integer" data-suffix="% warm" data-temperature-total="{param_temperature_total}"
                         data-temperature-warm="param_warm_level" data-temperature-cool="param_cool_level">
                </div>
              </div>
              <label class="switch-field" for="param_bounce">
                <span>Bounce</span>
                <input type="checkbox" id="param_bounce" name="BOUNCE"{param_bounce_checked} role="switch" aria-label="Bounce animation">
              </label>
              <div class="range-table">
                <div class="range-row">
                  <div class="range-label" id="range-delay-label">Delay/Speed (ms)</div>
                  <div class="range-inputs">
                    <input type="number" id="param_delay_min" name="DELAY_MIN" value="{param_delay_min_value}"
                           step="{param_delay_min_step}" inputmode="{param_delay_min_inputmode}" placeholder="Min"
                           aria-label="Delay minimum">
                    <input type="number" id="param_delay_max" name="DELAY_MAX" value="{param_delay_max_value}"
                           step="{param_delay_max_step}" inputmode="{param_delay_max_inputmode}" placeholder="Max"
                           aria-label="Delay maximum">
                  </div>
                </div>
                <div class="range-row">
                  <div class="range-label" id="range-trail-label">Trail</div>
                  <div class="range-inputs">
                    <input type="number" id="param_trail_min" name="TRAIL_MIN" value="{param_trail_min_value}"
                           step="{param_trail_min_step}" inputmode="{param_trail_min_inputmode}" placeholder="Min"
                           aria-label="Trail minimum">
                    <input type="number" id="param_trail_max" name="TRAIL_MAX" value="{param_trail_max_value}"
                           step="{param_trail_max_step}" inputmode="{param_trail_max_inputmode}" placeholder="Max"
                           aria-label="Trail maximum">
                  </div>
                </div>
                <div class="range-row">
                  <div class="range-label" id="range-endpoint-label">Endpoint</div>
                  <div class="range-inputs">
                    <input type="number" id="param_endpoint_min" name="MIN_ENDPOINT" value="{param_endpoint_min_value}"
                           step="{param_endpoint_min_step}" inputmode="{param_endpoint_min_inputmode}" placeholder="Min"
                           aria-label="Endpoint minimum">
                    <input type="number" id="param_endpoint_max" name="MAX_ENDPOINT" value="{param_endpoint_max_value}"
                           step="{param_endpoint_max_step}" inputmode="{param_endpoint_max_inputmode}" placeholder="Max"
                           aria-label="Endpoint maximum">
                  </div>
                </div>
                <div class="range-row">
                  <div class="range-label" id="range-motion-label">Motion Delay</div>
                  <div class="range-inputs">
                    <input type="number" id="param_motion_wait_min" name="MIN_MOTION_WAIT" value="{param_motion_wait_min_value}"
                           step="{param_motion_wait_min_step}" inputmode="{param_motion_wait_min_inputmode}" placeholder="Min"
                           aria-label="Motion wait minimum">
                    <input type="number" id="param_motion_wait_max" name="MAX_MOTION_WAIT" value="{param_motion_wait_max_value}"
                           step="{param_motion_wait_max_step}" inputmode="{param_motion_wait_max_inputmode}" placeholder="Max"
                           aria-label="Motion wait maximum">
                  </div>
                </div>
                <div class="range-row">
                  <div class="range-label" id="range-burst-gap-label">Burst Gap (ms)</div>
                  <div class="range-inputs">
                    <input type="number" id="param_burst_gap_min" name="BURST_GAP_MIN_MS" value="{param_burst_gap_min_value}"
                           step="{param_burst_gap_step}" inputmode="{param_burst_gap_inputmode}"
                           placeholder="Min" aria-label="Burst gap minimum">
                    <input type="number" id="param_burst_gap_max" name="BURST_GAP_MAX_MS" value="{param_burst_gap_max_value}"
                           step="{param_burst_gap_step}" inputmode="{param_burst_gap_inputmode}"
                           placeholder="Max" aria-label="Burst gap maximum">
                  </div>
                </div>
              </div>
              <input type="hidden" id="param_warm_level" name="WARM_LEVEL" value="{param_warm_level_value}">
              <input type="hidden" id="param_cool_level" name="COOL_LEVEL" value="{param_cool_level_value}">
            </div>
          </section>
          <footer class="actions-bar">
            <div class="actions">
              <button type="button" class="secondary" onclick="triggerFire()">Fire</button>
            </div>
          </footer>
        </form>
        <p id="status" role="status" aria-live="polite"></p>
      </article>
    </main>
    <script>
function submitSettingsForm(form) {{
  if (!form) {{
    return Promise.resolve();
  }}
  var formData = new FormData(form);
  var statusEl = document.getElementById('status');
  if (statusEl) {{
    statusEl.textContent = 'Saving...';
  }}
  return fetch('/set', {{
    method: 'POST',
    body: new URLSearchParams(formData).toString(),
    headers: {{'Content-Type': 'application/x-www-form-urlencoded'}}
  }})
    .then(function(response) {{
      if (!response.ok) {{
        throw new Error('HTTP ' + response.status);
      }}
      return response.json();
    }})
    .then(function() {{
      if (statusEl) {{
        statusEl.textContent = 'Saved.';
      }}
    }})
    .catch(function(err) {{
      console.log('Save failed', err);
      if (statusEl) {{
        statusEl.textContent = 'Save failed.';
      }}
    }});
}}

function saveSettings(event) {{
  event.preventDefault();
  submitSettingsForm(event.target);
}}

function triggerFire() {{
  fetch('/fire', {{method: 'POST'}})
    .then(function(response) {{
      if (!response.ok) {{
        throw new Error('HTTP ' + response.status);
      }}
      return response.json();
    }})
    .catch(function(err) {{
      console.log('Trigger FIRE failed', err);
    }});
}}

function formatOutputText(input) {{
  var format = input.getAttribute('data-format') || '';
  var value = input.value;
  var numeric = parseFloat(value);
  if (format === 'percent' && !isNaN(numeric)) {{
    return Math.round(numeric * 100) + '%';
  }}
  if (format === 'integer' && !isNaN(numeric)) {{
    return Math.round(numeric) + (input.getAttribute('data-suffix') || '');
  }}
  if (!isNaN(numeric)) {{
    var decimals = input.getAttribute('data-decimals');
    if (decimals) {{
      var places = parseInt(decimals, 10);
      if (!isNaN(places)) {{
        value = numeric.toFixed(places);
      }}
    }}
  }}
  var suffix = input.getAttribute('data-suffix') || '';
  return value + suffix;
}}

function bindSyncedInputs() {{
  document.querySelectorAll('input[data-sync]').forEach(function(input) {{
    var selector = input.getAttribute('data-sync');
    if (!selector) {{
      return;
    }}
    var target = document.querySelector(selector);
    if (!target) {{
      return;
    }}
    var syncValue = function(source, dest) {{
      dest.value = source.value;
    }};
    input.addEventListener('input', function() {{
      syncValue(input, target);
    }});
    syncValue(input, target);
  }});
}}

function bindTemperatureControls() {{
  document.querySelectorAll('input[data-temperature-warm]').forEach(function(slider) {{
    var warmId = slider.getAttribute('data-temperature-warm');
    var coolId = slider.getAttribute('data-temperature-cool');
    var totalAttr = slider.getAttribute('data-temperature-total');
    var warmInput = warmId ? document.getElementById(warmId) : null;
    var coolInput = coolId ? document.getElementById(coolId) : null;
    if (!warmInput && !coolInput) {{
      return;
    }}
    var warmInitial = warmInput ? parseFloat(warmInput.value) : NaN;
    var coolInitial = coolInput ? parseFloat(coolInput.value) : NaN;
    var hasInitialValues = false;
    var initialTotal = 0;
    if (isFinite(warmInitial) && warmInitial > 0) {{
      hasInitialValues = true;
      initialTotal += warmInitial;
    }}
    if (isFinite(coolInitial) && coolInitial > 0) {{
      hasInitialValues = true;
      initialTotal += coolInitial;
    }}
    var total = parseFloat(totalAttr);
    if (hasInitialValues) {{
      total = initialTotal;
    }}
    if (!isFinite(total) || total <= 0) {{
      total = 255;
    }}
    var updateTargets = function(value) {{
      var percent = parseFloat(value);
      if (isNaN(percent)) {{
        return;
      }}
      if (percent < 0) {{
        percent = 0;
      }} else if (percent > 100) {{
        percent = 100;
      }}
      var warmValue = Math.round((total * percent) / 100);
      var coolValue = Math.round(total - warmValue);
      if (warmInput) {{
        warmInput.value = warmValue;
      }}
      if (coolInput) {{
        coolInput.value = coolValue;
      }}
    }};
    slider.addEventListener('input', function() {{
      updateTargets(slider.value);
    }});
    if (hasInitialValues) {{
      updateTargets(slider.value);
    }}
  }});
}}

function bindOutputUpdates() {{
  document.querySelectorAll('input[data-output]').forEach(function(input) {{
    var outputId = input.getAttribute('data-output');
    var output = document.getElementById(outputId);
    if (!output) {{
      return;
    }}
    var update = function() {{
      output.textContent = formatOutputText(input);
    }};
    input.addEventListener('input', update);
    update();
  }});
}}

function bindAutosaveSettings() {{
  var form = document.getElementById('settings-form');
  if (!form) {{
    return;
  }}
  var pendingSave = null;
  var scheduleSave = function(delay) {{
    if (pendingSave) {{
      clearTimeout(pendingSave);
    }}
    pendingSave = setTimeout(function() {{
      pendingSave = null;
      submitSettingsForm(form);
    }}, delay);
  }};
  var immediateSave = function() {{
    scheduleSave(0);
  }};
  var debouncedSave = function() {{
    scheduleSave(400);
  }};
  var inputs = form.querySelectorAll('input');
  inputs.forEach(function(input) {{
    var type = (input.getAttribute('type') || '').toLowerCase();
    if (type === 'hidden' || input.disabled) {{
      return;
    }}
    if (type === 'range' || type === 'checkbox' || type === 'radio') {{
      input.addEventListener('change', immediateSave);
    }} else {{
      input.addEventListener('change', immediateSave);
      input.addEventListener('input', debouncedSave);
    }}
  }});
}}

function updatePowerState() {{
  var powerInput = document.getElementById('strip_on');
  var indicator = document.getElementById('power-state');
  if (!powerInput || !indicator) {{
    return;
  }}
  var onText = indicator.getAttribute('data-on') || 'On';
  var offText = indicator.getAttribute('data-off') || 'Off';
  indicator.textContent = powerInput.checked ? onText : offText;
}}

bindSyncedInputs();
bindTemperatureControls();
bindOutputUpdates();
bindAutosaveSettings();
updatePowerState();
var powerInput = document.getElementById('strip_on');
if (powerInput) {{
  powerInput.addEventListener('change', updatePowerState);
}}
    </script>
  </body>
</html>
